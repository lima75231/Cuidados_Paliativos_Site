<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagnóstico (ESAS)</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body>
  <header>
    <h1>Cuidados Paliativos em Foco</h1>
    <p>Cuidando com dignidade, acolhendo com respeito.</p>
  </header>

  <nav>
    <a href="../index.html">Início</a>
    <a href="sobre.html">Sobre</a>
    <a href="cuidados.html">Cuidados</a>
    <a href="equipe.html">Equipe</a>
    <a href="diario.html">Diário</a>
    <a href="recursos.html">Recursos</a>
    <a href="contato.html">Contato</a>
    <a href="participe.html">Participe</a>
    <a href="curso.html">Curso</a>
    <a href="diagnostico.html" class="active">Diagnóstico</a>
  </nav>

  <main>
    <h2>Ferramenta de Diagnóstico – ESAS (0–10)</h2>
    <p>Preencha os campos e gere o escore. Clique em “Salvar na planilha” para registrar a avaliação no Google Sheets.</p>

    <form id="formEsas" class="form-card">
      <label for="paciente">Paciente</label>
      <input id="paciente" name="paciente" type="text" placeholder="Nome completo" required>

      <label for="dataAvaliacao">Data da avaliação</label>
      <input id="dataAvaliacao" name="dataAvaliacao" type="date" required>

      <!-- ESAS: 9 itens clássicos -->
      <fieldset>
        <legend>ESAS – Sintomas (0 = ausência | 10 = pior possível)</legend>

        <label for="dor">Dor</label>
        <input id="dor" name="dor" type="range" min="0" max="10" value="0" oninput="out_dor.value=this.value">
        <div>Valor: <output id="out_dor">0</output></div>

        <label for="cansaco">Cansaço/Fadiga</label>
        <input id="cansaco" name="cansaco" type="range" min="0" max="10" value="0" oninput="out_cansaco.value=this.value">
        <div>Valor: <output id="out_cansaco">0</output></div>

        <label for="nausea">Náusea</label>
        <input id="nausea" name="nausea" type="range" min="0" max="10" value="0" oninput="out_nausea.value=this.value">
        <div>Valor: <output id="out_nausea">0</output></div>

        <label for="depressao">Depressão/Tristeza</label>
        <input id="depressao" name="depressao" type="range" min="0" max="10" value="0" oninput="out_depressao.value=this.value">
        <div>Valor: <output id="out_depressao">0</output></div>

        <label for="ansiedade">Ansiedade</label>
        <input id="ansiedade" name="ansiedade" type="range" min="0" max="10" value="0" oninput="out_ansiedade.value=this.value">
        <div>Valor: <output id="out_ansiedade">0</output></div>

        <label for="sonolencia">Sonolência</label>
        <input id="sonolencia" name="sonolencia" type="range" min="0" max="10" value="0" oninput="out_sonolencia.value=this.value">
        <div>Valor: <output id="out_sonolencia">0</output></div>

        <label for="apetite">Falta de apetite</label>
        <input id="apetite" name="apetite" type="range" min="0" max="10" value="0" oninput="out_apetite.value=this.value">
        <div>Valor: <output id="out_apetite">0</output></div>

        <label for="bemestar">Bem-estar (pior bem-estar)</label>
        <input id="bemestar" name="bemestar" type="range" min="0" max="10" value="0" oninput="out_bemestar.value=this.value">
        <div>Valor: <output id="out_bemestar">0</output></div>

        <label for="faltaAr">Falta de ar/Dispneia</label>
        <input id="faltaAr" name="faltaAr" type="range" min="0" max="10" value="0" oninput="out_faltaAr.value=this.value">
        <div>Valor: <output id="out_faltaAr">0</output></div>
      </fieldset>

      <label for="observacoes">Observações (opcional)</label>
      <textarea id="observacoes" name="observacoes" rows="3" placeholder="Anotações clínicas, intervenções, etc."></textarea>

      <div class="botoes">
        <button type="button" id="btnCalcular">Calcular escore</button>
        <button type="button" id="btnSalvar" class="btn-primary">Salvar na planilha</button>
        <button type="button" id="btnImprimir" class="btn-secondary">Imprimir / PDF</button>
        <button type="reset" class="btn-tertiary">Limpar</button>
      </div>
    </form>

    <section id="resultado" class="resultado-card" style="display:none;">
      <h3>Resultado</h3>
      <p id="resumo"></p>
      <ul id="detalhes" style="padding-left:18px;"></ul>
      <p id="notaLegal" class="muted">
        *Instrumento de triagem. Interpretar no contexto clínico e conforme protocolos locais.
      </p>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Cuidados Paliativos em Foco.</p>
  </footer>

  <script>
    // === CONFIGURE AQUI o endpoint do seu Apps Script ===
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/COLE_AQUI_O_URL_DO_SEU_DEPLOY/exec";

    function escoreCategoria(media){
      if (media < 3) return {rotulo:'Baixo', cor:'green'};
      if (media < 7) return {rotulo:'Moderado', cor:'orange'};
      return {rotulo:'Alto', cor:'red'};
    }

    function coletarValores(){
      const val = id => Number(document.getElementById(id).value);
      const payload = {
        paciente: document.getElementById('paciente').value.trim(),
        dataAvaliacao: document.getElementById('dataAvaliacao').value,
        dor: val('dor'),
        cansaco: val('cansaco'),
        nausea: val('nausea'),
        depressao: val('depressao'),
        ansiedade: val('ansiedade'),
        sonolencia: val('sonolencia'),
        apetite: val('apetite'),
        bemestar: val('bemestar'),
        faltaAr: val('faltaAr'),
        observacoes: document.getElementById('observacoes').value.trim()
      };
      const soma = payload.dor + payload.cansaco + payload.nausea + payload.depressao +
                   payload.ansiedade + payload.sonolencia + payload.apetite +
                   payload.bemestar + payload.faltaAr;
      const media = soma / 9;
      return { payload, soma, media: Number(media.toFixed(2)) };
    }

    document.getElementById('btnCalcular').addEventListener('click', () => {
      const {payload, soma, media} = coletarValores();
      if (!payload.paciente || !payload.dataAvaliacao) {
        alert('Preencha paciente e data.');
        return;
      }
      const cat = escoreCategoria(media);

      // resumo
      document.getElementById('resumo').innerHTML =
        `<strong>Paciente:</strong> ${payload.paciente} &nbsp;|&nbsp; ` +
        `<strong>Data:</strong> ${payload.dataAvaliacao}<br>` +
        `<strong>Soma ESAS:</strong> ${soma} &nbsp;|&nbsp; ` +
        `<strong>Média:</strong> ${media} — ` +
        `<span style="color:${cat.cor}; font-weight:700;">${cat.rotulo}</span>`;

      // detalhes
      const detalhes = document.getElementById('detalhes');
      detalhes.innerHTML = `
        <li>Dor: ${payload.dor}</li>
        <li>Cansaço/Fadiga: ${payload.cansaco}</li>
        <li>Náusea: ${payload.nausea}</li>
        <li>Depressão/Tristeza: ${payload.depressao}</li>
        <li>Ansiedade: ${payload.ansiedade}</li>
        <li>Sonolência: ${payload.sonolencia}</li>
        <li>Falta de apetite: ${payload.apetite}</li>
        <li>Pior bem-estar: ${payload.bemestar}</li>
        <li>Falta de ar: ${payload.faltaAr}</li>
      `;
      document.getElementById('resultado').style.display = 'block';
    });

    document.getElementById('btnSalvar').addEventListener('click', async () => {
      const {payload, soma, media} = coletarValores();
      if (!payload.paciente || !payload.dataAvaliacao) {
        alert('Preencha paciente e data.');
        return;
      }

      const btn = document.getElementById('btnSalvar');
      btn.disabled = true; btn.textContent = 'Salvando...';

      try {
        const body = JSON.stringify({ ...payload, soma, media });
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body
        });
        // Apps Script pode responder 200 com texto simples
        if (!res.ok) throw new Error('Falha no envio');
        alert('Avaliação salva na planilha com sucesso!');
      } catch (e) {
        console.error(e);
        alert('Não foi possível salvar. Verifique o endpoint do Apps Script e as permissões.');
      } finally {
        btn.disabled = false; btn.textContent = 'Salvar na planilha';
      }
    });

    document.getElementById('btnImprimir').addEventListener('click', () => window.print());
  </script>
</body>
</html>
